name: Build TriCNES
permissions:
  contents: read
  actions: read
  statuses: read

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            artifact-name: TriCNES-Windows
            binary-name: TriCNES.exe
            runtime-id: win-x64
          - os: ubuntu-latest
            artifact-name: TriCNES-Linux
            binary-name: TriCNES
            runtime-id: linux-x64
          - os: macos-latest
            artifact-name: TriCNES-macOS
            binary-name: TriCNES
            runtime-id: osx-x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup .NET SDK (cross-platform using actions/setup-dotnet)
      # This action handles installation per Microsoft's guidelines for all platforms
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # Change to your required version: 6.0.x, 7.0.x, 8.0.x, 9.0.x, 10.0.x
          
      - name: Display .NET info
        run: dotnet --info
      
      # Cache NuGet packages (cross-platform)
      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      # Restore dependencies
      - name: Restore dependencies
        run: dotnet restore TriCNES.sln
      
      # Build the solution
      - name: Build solution (Release)
        run: dotnet build TriCNES.sln --configuration Release --no-restore
      
      # Optional: Run tests if you have them
      # - name: Run tests
      #   run: dotnet test TriCNES.sln --configuration Release --no-build --verbosity normal
      
      # Publish for specific runtime (creates self-contained or framework-dependent deployment)
      - name: Publish application
        run: |
          dotnet publish TriCNES.sln \
            --configuration Release \
            --runtime ${{ matrix.runtime-id }} \
            --self-contained false \
            --output ./publish
      
      # Prepare upload folder
      - name: Prepare upload folder
        shell: bash
        run: |
          mkdir -p upload/tas upload/roms
          
          # Copy published files
          cp -r ./publish/* upload/ || {
            echo "Error: Publish directory not found!"
            echo "Contents of current directory:"
            ls -la
            echo "Searching for publish outputs..."
            find . -type d -name "publish" -o -name "Release"
            exit 1
          }
          
          # Make binary executable on Unix systems
          if [ "${{ runner.os }}" != "Windows" ]; then
            chmod +x upload/${{ matrix.binary-name }} 2>/dev/null || true
          fi
          
          # Verify binary exists
          if [ ! -f "upload/${{ matrix.binary-name }}" ]; then
            echo "Warning: Expected binary ${{ matrix.binary-name }} not found!"
            echo "Available files in upload directory:"
            ls -la upload/
          fi
          
          # Create README files
          echo "Place your Tool-Assisted Speedrun (TAS) input files here." > upload/tas/README.md
          echo "Place your NES ROM files here." > upload/roms/README.md
          
          # Create platform info
          cat > upload/BUILD_INFO.txt << EOF
          Platform: ${{ matrix.os }}
          Runtime: ${{ matrix.runtime-id }}
          Built on: $(date)
          Binary: ${{ matrix.binary-name }}
          .NET Version: $(dotnet --version)
          Commit: ${{ github.sha }}
          EOF
          
          # Create usage instructions
          if [ "${{ runner.os }}" = "Windows" ]; then
            echo "Run: TriCNES.exe" > upload/RUN.txt
          else
            echo "Run: ./${{ matrix.binary-name }}" > upload/RUN.txt
            echo "Make sure the binary is executable: chmod +x ${{ matrix.binary-name }}" >> upload/RUN.txt
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: upload
          retention-days: 90
          if-no-files-found: error

  # Optional: Create a combined release with all platforms
  create-release-package:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-builds
      
      - name: Create combined package
        run: |
          mkdir -p combined-release
          cd all-builds
          for dir in */; do
            platform_name=$(basename "$dir")
            mkdir -p "../combined-release/$platform_name"
            cp -r "$dir"/* "../combined-release/$platform_name/"
          done
          cd ..
          
          # Create a summary README
          cat > combined-release/README.md << 'EOF'
          # TriCNES - Multi-Platform Build
          
          This package contains builds for multiple platforms:
          
          ## Windows
          - Navigate to `TriCNES-Windows/`
          - Run `TriCNES.exe`
          
          ## Linux
          - Navigate to `TriCNES-Linux/`
          - Make executable: `chmod +x TriCNES`
          - Run: `./TriCNES`
          
          ## macOS
          - Navigate to `TriCNES-macOS/`
          - Make executable: `chmod +x TriCNES`
          - Run: `./TriCNES`
          
          ## Folders
          - `tas/` - Place your Tool-Assisted Speedrun input files here
          - `roms/` - Place your NES ROM files here
          EOF
      
      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: TriCNES-All-Platforms
          path: combined-release
          retention-days: 90
